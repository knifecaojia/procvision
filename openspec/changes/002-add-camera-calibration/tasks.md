# 相机标定功能任务列表

## 阶段1: 核心服务和数据模型

### 任务 1.1: 创建标定数据模型
**描述**: 定义标定相关的数据结构（CalibrationImage, CalibrationResult, ChessboardConfig）
**依赖**: 无
**验证**: 单元测试验证数据模型创建和序列化
**估算**: 2小时

**子任务:**
- [ ] 创建 `src/camera/calibration/__init__.py`
- [ ] 创建 `src/camera/calibration/calibration_data.py`
- [ ] 实现数据类（dataclass）
- [ ] 添加JSON序列化/反序列化方法
- [ ] 编写单元测试

---

### 任务 1.2: 实现棋盘格检测器
**描述**: 使用OpenCV实现棋盘格角点检测功能
**依赖**: 任务 1.1
**验证**: 单元测试验证角点检测准确性
**估算**: 3小时

**子任务:**
- [ ] 创建 `src/camera/calibration/chessboard_detector.py`
- [ ] 实现 `detect_chessboard_corners()` 函数
- [ ] 添加亚像素角点精确化
- [ ] 实现角点可视化（用于调试）
- [ ] 编写单元测试（使用示例图像）

---

### 任务 1.3: 实现相机标定服务
**描述**: 实现核心的相机标定逻辑
**依赖**: 任务 1.1, 任务 1.2
**验证**: 集成测试验证完整标定流程
**估算**: 4小时

**子任务:**
- [ ] 创建 `src/camera/calibration/calibration_service.py`
- [ ] 实现 `CalibrationService` 类
- [ ] 实现图像捕获和验证逻辑
- [ ] 实现标定计算（调用cv2.calibrateCamera）
- [ ] 实现重投影误差计算
- [ ] 编写集成测试

---

### 任务 1.4: 实现标定数据持久化
**描述**: 实现标定结果的JSON存储和读取
**依赖**: 任务 1.1
**验证**: 单元测试验证文件读写和版本兼容性
**估算**: 2小时

**子任务:**
- [ ] 创建 `src/camera/calibration/storage.py`
- [ ] 实现 `CalibrationStorage` 类
- [ ] 实现存储路径管理（跨平台）
- [ ] 实现JSON文件的读写
- [ ] 添加版本控制和向后兼容
- [ ] 编写单元测试

---

## 阶段2: UI层实现

### 任务 2.1: 设计标定对话框UI
**描述**: 设计标定对话框的UI布局和交互流程
**依赖**: 任务 1.3
**验证**: 通过UI设计审查
**估算**: 2小时

**子任务:**
- [ ] 创建UI布局草图
- [ ] 定义用户交互流程
- [ ] 确定控件类型和属性
- [ ] 评审和优化设计

---

### 任务 2.2: 实现标定对话框
**描述**: 实现标定对话框的PySide6 UI代码
**依赖**: 任务 1.3, 任务 2.1
**验证**: 手动测试UI显示和交互
**估算**: 4小时

**子任务:**
- [ ] 创建 `src/ui/pages/camera_calibration_dialog.py`
- [ ] 实现对话框布局（棋盘格设置、预览、图像列表、控制按钮）
- [ ] 实现实时预览显示
- [ ] 实现图像列表（QListWidget + 缩略图）
- [ ] 实现进度更新（采集数量、标定按钮状态）
- [ ] 实现标定结果展示

---

### 任务 2.3: 集成CameraService到对话框
**描述**: 在标定对话框中集成相机服务，实现帧捕获和标定逻辑调用
**依赖**: 任务 1.3, 任务 2.2
**验证**: 手动测试连接相机、捕获帧、执行标定
**估算**: 3小时

**子任务:**
- [ ] 在对话框中初始化CalibrationService
- [ ] 实现实时预览更新（使用QTimer）
- [ ] 实现【采集图像】按钮逻辑（捕获帧+角点检测）
- [ ] 实现【标定】按钮逻辑（调用CalibrationService.calibrate）
- [ ] 实现进度显示和错误处理

---

### 任务 2.4: 在CameraPage添加标定按钮
**描述**: 修改相机页面，添加打开标定对话框的入口
**依赖**: 任务 2.2, 任务 2.3
**验证**: 手动测试从相机页面打开标定对话框
**估算**: 1小时

**子任务:**
- [ ] 在 `src/ui/pages/camera_page.py` 的预览控制栏添加"标定"按钮
- [ ] 实现按钮的启用/禁用逻辑（相机连接时可用）
- [ ] 实现点击事件，弹出CameraCalibrationDialog
- [ ] 测试对话框生命周期管理（打开、关闭、资源释放）

---

## 阶段3: 集成和配置

### 任务 3.1: 扩展CameraService
**描述**: 在CameraService中暴露标定服务接口
**依赖**: 任务 1.3
**验证**: 单元测试验证CameraService.calibration_service属性
**估算**: 1小时

**子任务:**
- [ ] 在 `src/camera/camera_service.py` 中增加calibration_service属性
- [ ] 实现get_current_frame()方法（用于标定帧捕获）
- [ ] 编写集成测试

---

### 任务 3.2: 添加配置文件支持
**描述**: 在app_config.json中添加标定配置项
**依赖**: 任务 1.4
**验证**: 验证配置文件正确加载
**估算**: 1小时

**子任务:**
- [ ] 在 `config/app_config.json` 中添加calibration配置节
- [ ] 添加配置项：存储目录、默认棋盘格规格、最小图像数
- [ ] 在代码中加载和使用配置

---

### 任务 3.3: 添加OpenCV依赖
**描述**: 在requirements.txt中添加opencv-python依赖
**依赖**: 任务 1.2
**验证**: 安装验证和基本功能测试
**估算**: 0.5小时

**子任务:**
- [ ] 在 `requirements.txt` 中添加opencv-python>=4.5.0
- [ ] 更新setup.py（如存在）
- [ ] 创建简单的依赖测试脚本

---

## 阶段4: 测试和优化

### 任务 4.1: 编写单元测试
**描述**: 为标定服务和数据模型编写完整的单元测试
**依赖**: 阶段1所有任务
**验证**: 所有测试通过，代码覆盖率>80%
**估算**: 3小时

**子任务:**
- [ ] 创建 `tests/camera/test_calibration_data.py`
- [ ] 创建 `tests/camera/test_chessboard_detector.py`
- [ ] 创建 `tests/camera/test_calibration_service.py`
- [ ] 使用pytest-mock模拟相机捕获
- [ ] 使用示例图像测试角点检测

---

### 任务 4.2: 创建示例图像数据集
**描述**: 创建用于测试的棋盘格标定图像数据集
**依赖**: 任务 4.1
**验证**: 测试集能被测试代码正确加载和使用
**估算**: 1小时

**子任务:**
- [ ] 创建 `tests/data/calibration/` 目录
- [ ] 生成15-20张合成的棋盘格图像（不同角度和距离）
- [ ] 验证图像质量和多样性

---

### 任务 4.3: 手动测试和优化
**描述**: 进行完整的手动测试，优化用户体验
**依赖**: 阶段2、阶段3所有任务
**验证**: 所有测试场景通过
**估算**: 2小时

**测试场景:**
- [ ] 连接相机，打开标定对话框
- [ ] 调整棋盘格参数，验证实时预览
- [ ] 采集15张图像，验证角点检测
- [ ] 执行标定，验证结果和误差计算
- [ ] 验证JSON文件生成和内容完整性
- [ ] 测试异常场景（相机断开、检测失败等）
- [ ] 验证UI响应性和视觉效果

---

### 任务 4.4: 性能优化
**描述**: 优化标定过程中的内存使用和计算性能
**依赖**: 任务 4.3
**验证**: 10MP+相机标定内存使用<2GB
**估算**: 2小时

**优化项:**
- [ ] 缩略图使用降采样图像（200x200）
- [ ] 标定计算在后台线程执行
- [ ] 添加进度条显示标定进度
- [ ] 优化角点检测预览性能

---

## 阶段5: 文档和部署

### 任务 5.1: 编写用户文档
**描述**: 编写相机标定功能的使用说明
**依赖**: 阶段4完成
**验证**: 用户能根据文档独立完成标定
**估算**: 1小时

**交付物:**
- [ ] 创建 `docs/camera_calibration_guide.md`
- [ ] 中文和英文版本
- [ ] 包含截图和操作步骤
- [ ] 故障排除指南

---

### 任务 5.2: 更新API文档
**描述**: 为标定服务API添加文档字符串和说明
**依赖**: 阶段1完成
**验证**: 文档完整、准确
**估算**: 1小时

**子任务:**
- [ ] 完善所有公共方法的中文和英文docstring
- [ ] 添加参数和返回值的详细说明
- [ ] 添加使用示例

---

## 总结

**总估算时间**: 30.5小时（约4个工作日）

**关键依赖路径:**
1. 任务 1.1 → 任务 1.2 → 任务 1.3 → 阶段2
2. 任务 1.3 → 任务 1.4 → 阶段3
3. 阶段1 + 阶段2 + 阶段3 → 阶段4

**风险点:**
- OpenCV安装和依赖兼容性
- 多相机环境下的测试覆盖
- HiKSDK与OpenCV的图像格式转换

**并行任务:**
- 任务 1.4 可以与任务 1.3 并行执行
- 任务 2.1 可以与任务 1.3 并行执行
- 任务 3.1 可以与任务 1.3 并行执行
